<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <header class="site-header">
        <img src="/images/logo.png" alt="Teacher Rating Logo" class="logo" onclick="window.location.href='/'">
        <h1 class="header-title">Admin Dashboard</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </header>
    <div class="admin-container">
        <div class="admin-section">
            <h2>Manage Teachers</h2>
            <div class="admin-list" id="teacher-list"></div>
            <form id="add-teacher-form">
                <label for="teacher-name">Name:</label>
                <input type="text" id="teacher-name" required>
                <label for="teacher-bio">Bio:</label>
                <textarea id="teacher-bio" required></textarea>
                <label for="teacher-summary">Summary:</label>
                <textarea id="teacher-summary" required></textarea>
                <label for="teacher-classes">Classes (comma-separated):</label>
                <input type="text" id="teacher-classes">
                <button type="submit">Add Teacher</button>
            </form>
        </div>
        <div class="admin-section">
            <h2>Manage Votes</h2>
            <div class="admin-list" id="vote-list"></div>
        </div>
    </div>
    <footer>
        <p>Missing Teacher? Contact <a href="mailto:reagan.hartney@gmail.com">reagan.hartney@gmail.com</a> to add a teacher!</p>
    </footer>
    <script>
        const token = localStorage.getItem('adminToken');
        if (!token) window.location.href = '/admin/login.html';

        async function loadTeachers() {
            const response = await fetch('/api/teachers', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const teachers = await response.json();
            const list = document.getElementById('teacher-list');
            list.innerHTML = '';
            teachers.forEach(teacher => {
                const item = document.createElement('div');
                item.className = 'admin-item';
                item.innerHTML = `<p>${teacher.name}</p><div class="admin-actions"><button onclick="deleteTeacher(${teacher.id})">Delete</button></div>`;
                list.appendChild(item);
            });
        }

        async function loadVotes() {
            const response = await fetch('/api/admin/votes', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const votes = await response.json();
            const list = document.getElementById('vote-list');
            list.innerHTML = '';
            votes.forEach(vote => {
                const teacher = teachers.find(t => t.id === vote.teacher_id);
                if (teacher) {
                    const item = document.createElement('div');
                    item.className = 'admin-item';
                    item.innerHTML = `<p>${teacher.name} - ${'★'.repeat(vote.rating)}${'☆'.repeat(5 - vote.rating)} - ${vote.review || 'No review'}</p><div class="admin-actions"><button onclick="modifyVote(${vote.teacher_id})">Modify</button><button onclick="deleteVote(${vote.teacher_id})">Delete</button></div>`;
                    list.appendChild(item);
                }
            });
        }

        document.getElementById('add-teacher-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('teacher-name').value;
            const bio = document.getElementById('teacher-bio').value;
            const summary = document.getElementById('teacher-summary').value;
            const classes = document.getElementById('teacher-classes').value.split(',').map(c => c.trim());
            await fetch('/api/teachers', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, bio, summary, classes })
            });
            loadTeachers();
            e.target.reset();
        });

        async function modifyVote(teacherId) {
            const rating = prompt('Enter new rating (1-5):');
            const review = prompt('Enter new review (optional):');
            if (rating && !isNaN(rating) && rating >= 1 && rating <= 5) {
                await fetch(`/api/admin/votes/${teacherId}`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ rating: parseInt(rating), review })
                });
                loadVotes();
            }
        }

        async function deleteVote(teacherId) {
            if (confirm('Are you sure you want to delete this vote?')) {
                await fetch(`/api/admin/votes/${teacherId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadVotes();
            }
        }

        async function deleteTeacher(id) {
            if (confirm('Are you sure you want to delete this teacher and their votes?')) {
                await fetch(`/api/admin/teachers/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadTeachers();
                loadVotes();
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login.html';
        }

        loadTeachers();
        loadVotes();
    </script>
</body>
</html>